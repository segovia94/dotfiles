#!/bin/bash

# Create a new directory and enter it
function md() {
	mkdir -p "$@" && cd "$@"
}

# find shorthand
function f() {
	find . -name "$1" 2>&1 | grep -v 'Permission denied'
}

# List all files, long format, colorized, permissions in octal
function la() {
  ls -l  "$@" | awk '
    {
      k=0;
      for (i=0;i<=8;i++)
        k+=((substr($1,i+2,1)~/[rwx]/) *2^(8-i));
      if (k)
        printf("%0o ",k);
      printf(" %9s  %3s %2s %5s  %6s  %s %s %s\n", $3, $6, $7, $8, $5, $9,$10, $11);
    }'
}

# Copy w/ progress
cp_p () {
  rsync -WavP --human-readable --progress $1 $2
}

# get gzipped size
function gz() {
	echo "orig size    (bytes): "
	cat "$1" | wc -c
	echo "gzipped size (bytes): "
	gzip -c "$1" | wc -c
}

# preview csv files. source: http://stackoverflow.com/questions/1875305/command-line-csv-viewer
function csvpreview() {
  sed 's/,,/, ,/g;s/,,/, ,/g' "$@" | column -s, -t | less -#2 -N -S
}

# direct it all to /dev/null
function nullify() {
  "$@" >/dev/null 2>&1
}

function get_lando_file() {
  FILE=$PWD/.lando.yml

  curl https://raw.githubusercontent.com/segovia94/drupal-local-settings/master/.lando.yml -o $FILE

  if (( $# == 1 ))
  then
    # Replace space with dash.
    name="${1// /-}"
    # Lowercase.
    name="${name,,}"

    # Replace site name and url.
    sed -i "s/name: drupal/name: $name/" $FILE
    sed -i "s/drupal.lndo/$name.lndo/" $FILE
  fi  
}

# Move a site created by "lando composer" into the current directory
function move_site() {
	mv $1/* $1/.[^.]* .
	rm -rf newsite/
	echo "Site moved: rebuilding Lando"
	lando rebuild -y
}

function drupal_local_settings() {
  # services.local.yml
  curl https://raw.githubusercontent.com/segovia94/drupal-local-settings/master/services.local.yml -o $PWD/web/sites/default/services.local.yml
  # settings.local.php
  curl https://raw.githubusercontent.com/segovia94/drupal-local-settings/master/settings.local.php -o $PWD/web/sites/default/settings.local.php
  # settings.php
  FILE=$PWD/web/sites/default/settings.php
  if [ ! -f "$FILE" ]; then
    curl https://raw.githubusercontent.com/segovia94/drupal-local-settings/master/settings.php -o $FILE
  else
    echo "$FILE exists."

    # Check to see if the local settings is already enabled.
    if grep -Pq "(?<!(# ))if(.)+local.php" "$FILE"; then
      echo "Local settings already enabled."
    else
      cat >> $FILE <<EOF

if (file_exists(\$app_root . '/' . \$site_path . '/settings.local.php')) {
  include \$app_root . '/' . \$site_path . '/settings.local.php';
}
EOF
    fi
  fi
  echo "Your local Drupal config is setup."
}

function drupal_install() {
  local name="${1:-New Site}"
  echo $name
  lando drush si standard --account-pass=admin --account-name=admin --site-name="$name" -y
  lando drush uli
}

# Get Drupal via composer in lando https://github.com/drupal-composer/drupal-project
alias get_drupal="lando composer create-project drupal-composer/drupal-project:9.x-dev newsite --no-interaction && move_site newsite"

# Create a new Drupal site via Composer.
# @param name - pass in a Site Name which will also be used as the domain.
# Ex. new_drupal "Test Site"
function new_drupal() {
  get_lando_file "$1"
  get_drupal
  drupal_local_settings
  drupal_install "$1"
}
